# Week 3: API code and SPV nodes

## API modules: wallet/node, http/rpc

Time to dig in to some code!

Recall that bcoin runs two servers: a full node and a wallet. Each server
has two APIs: JSON-RPC and REST. You can find those four discreet files in
the library:

```
lib/node/http.js
lib/node/rpc.js
lib/wallet/http.js
lib/wallet/rpc.js
```

The two RPC servers have their own test modules:

```
test/wallet-rpc-test.js
test/node-rpc-test.js
```

Unfortunately, the REST API tests are not very obvious. They
are combined into this file:

```
test/http-test.js
```

Take a look at these test files and try to match up the test blocks with the
functions in the actual library modules. You can run a test individually like this:

```
npm run test-file test/node-rpc-test.js
```

Can you intentionally make a test fail by changing code in one of the test blocks?
More importantly: can you make a test fail by changing code in the library functions?
MOST importantly: can you find a way to modify the code in a library function that
DOES NOT break a test but should?

For example, we have been using the `generatetoaddress`
RPC call quite a bit in the first two weeks. The implementation of that RPC
method is [here](https://github.com/bcoin-org/bcoin/blob/master/lib/node/rpc.js#L1705-L1719).
Can you break the code in some way that the tests don't catch? If you can accomplish this
(no guarantees that you can) then can you add a test to cover the code? That is a huge
help! Please open a pull request to bcoin with your additional test coverage!

It may be quite hard to break an RPC method without failing the tests, but that's
OK there is a much simpler way to contribute: just add more test coverage.

You can see using `codecov` that the four API modules are not well covered by
the tests:

https://codecov.io/gh/bcoin-org/bcoin/src/master/lib/node/http.js

https://codecov.io/gh/bcoin-org/bcoin/src/master/lib/node/rpc.js

https://codecov.io/gh/bcoin-org/bcoin/src/master/lib/wallet/http.js

https://codecov.io/gh/bcoin-org/bcoin/src/master/lib/wallet/rpc.js

As you scroll through these visualizations you should notice the green and red lines,
which represent covered and un-covered code. These webpages are generated by
our CI service ("Continuous Integration") on master branch, and it also runs on
any submitted pull request. You can generate these HTML files locally if you install
[nyc](https://www.npmjs.com/package/nyc) but that is probably not worth your time.

Anyway, this week's task is fairly simple: **open a pull request that adds test
coverage to bcoin.**

Here are some example of simple PRs that added good test coverage to the API modules:

https://github.com/bcoin-org/bcoin/pull/919

https://github.com/bcoin-org/bcoin/pull/802

https://github.com/bcoin-org/bcoin/pull/810

You may want to even browse through the [API docs](https://bcoin.io/api-docs/)
to pick out commands to test. Does something look wrong in the documentation?
You can open a pull request for the API docs in [this repository](https://github.com/bcoin-org/bcoin-org.github.io).

## SPV Nodes

We are going to run our first node on **MAINNET**!

⚠️ REAL MONEY WARNING ⚠️

Don't worry, we are going to keep it simple to start. As you are probably aware
a Bitcoin Full Node can take days to fully sync and require hundreds of gigabytes
of disk space. We are going to simplify that a good deal by taking advantage
of a unique feature of bcoin: SPV MODE.

Reading: 

https://github.com/bitcoin/bips/blob/master/bip-0037.mediawiki

https://en.bitcoin.it/wiki/BIP37_privacy_problems

https://bitcoinops.org/en/newsletters/2019/07/31/#bloom-filter-discussion

https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2019-July/017145.html

SPV mode is defined in section 8 of [Satoshi's whitepaper](https://bitcoin.org/bitcoin.pdf)
and will be completely deprecated soon. For now we can still try it out.

A bcoin SPV node on mainnet may still take about 3-4 hours to sync but it will
only use up about 180 MB of disk space.

Terminal 1: Start bcoin in SPV mode

```
bcoin --spv
```

You will need to let this run for a while! You can watch the sync progress in
a separate terminal with:

```
watch --interval 2 bcoin-cli info
```

Terminal 2: Create a wallet with a specific private key

⚠️ REAL MONEY WARNING ⚠️

The private key I'm about to give you is a TEST KEY. It encodes this entropy seed:

```
0x00000000000000000000000000000000
```

So keep in mind, **EVERYONE KNOWS THIS PRIVATE KEY!** The reason we are going to
use this is because this particular test wallet already has a ton of blockchain
activity.

While bcoin is syncing in SPV mode create a wallet with this specific seed phrase:

```
bwallet-cli mkwallet --id=abandon \
  --mnemonic="abandon abandon abandon abandon abandon abandon \
  abandon abandon abandon abandon abandon about"
```

Then execute this command:

```
bwallet-cli --id=abandon listen
```

This command will NOT return anything right away. In fact, the "abandon" wallet
won't have any activity until block height `329232` or so, so no need to stare
at the `listen` command all night. What it will do is "listen"
for wallet events. As the wallet syncs the blockchain in SPV mode it will
start to discover transactions sent to and from this wallet! Bcoin has an
elaborate JavaScript events system and this command sends those events right
to the terminal.

You can read all about the event in bcoin [in this guide.](https://bcoin.io/guides/events.html)

Meanwhile you can play with some of the data you have already downloaded. What happens
when you execute these two commands? Do you know why?

```
bcoin-cli block 10000
bcoin-cli header 10000
```

What other commands work / don't work in SPV mode?

Once you are fully synced, all of the wallet API commands should work. What kind
of things can you learn about this wallet? How many transactions are there?
Does it still have a spendable balance?

## Bonus homework

⚠️ REAL MONEY WARNING ⚠️

Create YOUR OWN wallet with this mainnet SPV node. Make sure it is a segwit
wallet by setting `--witness=true` in your `mkwallet` command. BACK UP YOUR SEED
PHRASE! Encrypt your wallet: https://bcoin.io/api-docs/#encryptwallet

Finally, send me your Bitcoin address! I will send you $10 in real Bitcoin!

Can you send some of this BTC to each other? Can you find something online
to buy with it?
